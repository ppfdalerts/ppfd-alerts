<!doctype html>
<meta name=viewport content="width=device-width, initial-scale=1">
<title>PPFD Live Leaderboards</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#151a20; --text:#e5e7eb; --muted:#9ca3af;
    --red:#ef4444; --gold:#f59e0b; --smoke:#374151; --accent:#ff7043;
    --green:#22c55e; --teal:#14b8a6; --blue:#3b82f6; --indigo:#6366f1;
  }
  *{box-sizing:border-box}
  html,body{height:100%; width:100%;}
  body{margin:0; background:linear-gradient(180deg, #0b0d10, #0e1216); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh; width:100vw; padding:8px 10px;}
  .toolbar{display:flex; align-items:center; gap:12px; margin:4px 0 8px;}
  .pill{background:#1f2937; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .btn{background:#1f2937; border:1px solid #111722; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer}
  .btn:hover{background:#223047}
  .canvas{position:relative; height:100%; width:100%;}
  .panel{position:absolute; background:var(--panel); border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.35); overflow:hidden; border:1px solid #111722; display:flex; flex-direction:column; min-height:60px; min-width:120px}
  .panel .hdr{display:flex; align-items:center; gap:10px; padding:10px 12px; font-weight:700; letter-spacing:.3px; text-transform:uppercase; font-size:13px; flex:0 0 auto; border-bottom:1px solid #0f141a;}
  .panel .hdr .dot{width:10px; height:10px; border-radius:50%}
  .panel .hdr .sub{margin-left:auto; color:var(--muted); font-weight:500}
  .panel .body{margin:0; padding:0 12px 12px; overflow:auto}
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{position:sticky; top:0; background:#0f141a; color:#9ca3af; text-align:left; font-weight:700; padding:10px 6px; border-bottom:1px solid #1f2937}
  tbody td{padding:10px 6px; border-bottom:1px dashed #1f2732}
  tbody tr:nth-child(odd){background:rgba(255,255,255,0.015)}
  tbody tr:hover{background:#111722}
  .col-unit{width:20%}
  .col-calls{width:16%}
  .col-avg{width:22%}
  .col-max{width:22%}
  .col-after{width:20%}
  /* Rank accents */
  tr.rank-1 td{background:linear-gradient(90deg, rgba(245,158,11,.15), transparent);} /* gold */
  tr.rank-2 td{background:linear-gradient(90deg, rgba(99,102,241,.12), transparent);} /* indigo */
  tr.rank-3 td{background:linear-gradient(90deg, rgba(20,184,166,.12), transparent);} /* teal */
  /* Badges */
  .pill-badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px}
  .after-badge{background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35)}
  .calls-badge{background:rgba(34,197,94,.16); color:#bbf7d0; border:1px solid rgba(34,197,94,.35)}
  .avg-badge{background:rgba(59,130,246,.16); color:#bfdbfe; border:1px solid rgba(59,130,246,.35)}
  .grip{position:absolute; right:6px; bottom:6px; width:16px; height:16px; color:#728090; opacity:.35}
  .grid{display:none}
  .timestamp{margin-left:auto; color:var(--muted); font-size:12px}
  .footer{position:absolute; left:10px; bottom:8px; color:var(--muted); font-size:12px}
  .panel .hdr .dot.today{background:var(--gold)}
  .panel .hdr .dot.prior{background:var(--accent)}
  .panel .hdr .dot.week{background:var(--smoke)}`n  .panel .hdr .dot.month{background:var(--teal)}

  /* Mobile layout */
  @media (max-width: 900px){
    .wrap{padding:6px}
    .toolbar{gap:8px}
    .canvas{display:flex; flex-direction:column; gap:10px}
    .panel{position:static; width:100% !important; height:auto !important}
    .panel .hdr{font-size:12px; padding:10px}
    table{font-size:13px}
    thead th, tbody td{padding:8px 6px}
    .grip{display:none}
  }
</style>
<div class="wrap">
  <div class="toolbar">
    <div class="pill">PPFD Leaderboards</div>
    <div class="pill">Auto refresh
      <label style="margin-left:4px"><input id="auto" type="checkbox" checked></label>
    </div>
    <button id="refresh" class="btn">Refresh now</button>
    <div id="ts" class="timestamp">—</div>
  </div>
  <div class="canvas">
    <div class="panel" id="panel-today" style="left:2vw; top:8vh; width:46vw; height:84vh">
      <div class="hdr"><span class="dot today"></span><span>Today</span><span id="hdr-today" class="sub">—</span></div>
      <div class="body"><table id="board-today"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-prior" style="left:50vw; top:8vh; width:46vw; height:30vh">
      <div class="hdr"><span class="dot prior"></span><span>Prior Shift</span><span id="hdr-prior" class="sub">—</span></div>
      <div class="body"><table id="board-prior"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-week" style="left:50vw; top:40vh; width:46vw; height:28vh">
      <div class="hdr"><span class="dot week"></span><span>Week</span><span id="hdr-week" class="sub">—</span></div>
      <div class="body"><table id="board-week"><thead><tr>
        <th class="col-unit">Unit</th>
        <th>Total Calls (A|B|C)</th>
        <th>Single-Shift Max Calls (A|B|C)</th>
        <th>Avg. Call Duration (Mins) (A|B|C)</th>
        <th>Highest Call Duration (Mins) (A|B|C)</th>
        <th>Total Calls After Midnight (A|B|C)</th>
        <th>Single-Shift Max After Midnight (A|B|C)</th>
      </tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-month" style="left:50vw; top:70vh; width:46vw; height:22vh">
      <div class="hdr"><span class="dot month"></span><span>Month</span><span id="hdr-month" class="sub">—</span></div>
      <div class="body"><table id="board-month"><thead><tr>
        <th class="col-unit">Unit</th>
        <th>Total Calls (A|B|C)</th>
        <th>Single-Shift Max Calls (A|B|C)</th>
        <th>Avg. Call Duration (Mins) (A|B|C)</th>
        <th>Highest Call Duration (Mins) (A|B|C)</th>
        <th>Total Calls After Midnight (A|B|C)</th>
        <th>Single-Shift Max After Midnight (A|B|C)</th>
      </tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="footer">Updated <span id="updated">—</span></div>
  </div>
</div>
<script>
  const el = {
    today: document.getElementById('board-today'),
    prior: document.getElementById('board-prior'),
    week: document.getElementById('board-week'),
    month: document.getElementById('board-month'),
    hdrToday: document.getElementById('hdr-today'),
    hdrPrior: document.getElementById('hdr-prior'),
    hdrWeek: document.getElementById('hdr-week'),
    hdrMonth: document.getElementById('hdr-month'),
    ts: document.getElementById('ts'),
    upd: document.getElementById('updated'),
    auto: document.getElementById('auto'),
    refresh: document.getElementById('refresh')
  };

  function renderTable(table, data){
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      const tr=document.createElement('tr');
      const td=document.createElement('td'); td.colSpan=(table.querySelectorAll("thead th").length||4); td.textContent='No runs recorded.'; td.style.color='#9ca3af'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    const rows = data.rows;
    const maxC = Math.max(...rows.map(r=>r.calls));
    const minC = Math.min(...rows.map(r=>r.calls));
    const callsHeat = (c)=>{
      const n = maxC===minC? 0.7 : (c-minC)/(maxC-minC);
      const hue = 200 - Math.round(n*160); // teal->gold spectrum
      const alpha = 0.22 + 0.28*n;
      return `background: hsla(${hue}, 85%, 52%, ${alpha}); color: #0b0d10; font-weight:700; border-radius:6px; padding:2px 8px; display:inline-block;`;
    };
    rows.forEach((r, idx)=>{
      const tr=document.createElement('tr');
      if(idx===0) tr.classList.add('rank-1');
      if(idx===1) tr.classList.add('rank-2');
      if(idx===2) tr.classList.add('rank-3');
      const tdU=document.createElement('td'); tdU.textContent=r.unit; tdU.className='col-unit'; tr.appendChild(tdU);
      const tdC=document.createElement('td'); tdC.className='col-calls'; tdC.innerHTML = `<span class="pill-badge calls-badge" style="${callsHeat(r.calls)}">${r.calls}</span>`; tr.appendChild(tdC);
      const tdA=document.createElement('td'); tdA.className='col-avg'; tdA.innerHTML = `<span class="pill-badge avg-badge">${r.avg_min.toFixed(1)}</span>`; tr.appendChild(tdA);
      const thCount = table.querySelectorAll('thead th').length;
      if(thCount >= 5){
        const tdX=document.createElement('td'); tdX.className='col-max';
        const show = (r.max_min && r.max_min>0) ? r.max_min.toFixed(1) : '—';
        tdX.innerHTML = `<span class="pill-badge avg-badge">${show}</span>`;
        tr.appendChild(tdX);
      }
      const tdM=document.createElement('td'); tdM.className='col-after';
      if((r.after_0000||0)>0){ tdM.innerHTML = `<span class="pill-badge after-badge">${r.after_0000}</span>`; }
      else { tdM.textContent = '0'; tdM.style.color = '#9ca3af'; }
      tr.appendChild(tdM);
      tbody.appendChild(tr);
    });
  }

  function renderWeekMonth(table, data){
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      const tr=document.createElement('tr');
      const td=document.createElement('td'); td.colSpan=(table.querySelectorAll('thead th').length||7); td.textContent='No runs recorded.'; td.style.color='#9ca3af'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    const abc = (arr, isFloat=false)=>{
      const f = (v)=> isFloat ? (Number.isFinite(v)? v.toFixed(1):'0.0') : (v||0);
      return `${f(arr[0]||0)}|${f(arr[1]||0)}|${f(arr[2]||0)}`;
    };
    data.rows.forEach((r, idx)=>{
      const tr=document.createElement('tr');
      if(idx===0) tr.classList.add('rank-1');
      if(idx===1) tr.classList.add('rank-2');
      if(idx===2) tr.classList.add('rank-3');
      const tdU=document.createElement('td'); tdU.textContent=r.unit; tr.appendChild(tdU);
      const td1=document.createElement('td'); td1.textContent=abc(r.calls_abc,false); tr.appendChild(td1);
      const td2=document.createElement('td'); td2.textContent=abc(r.calls_max_abc,false); tr.appendChild(td2);
      const td3=document.createElement('td'); td3.textContent=abc(r.avg_min_abc,true); tr.appendChild(td3);
      const td4=document.createElement('td'); td4.textContent=abc(r.max_min_abc,true); tr.appendChild(td4);
      const td5=document.createElement('td'); td5.textContent=abc(r.after_abc,false); tr.appendChild(td5);
      const td6=document.createElement('td'); td6.textContent=abc(r.after_max_abc,false); tr.appendChild(td6);
      tbody.appendChild(tr);
    });
  }

  function apply(data){
    if(data.today){ renderTable(el.today, data.today); el.hdrToday.textContent=(data.today.meta && data.today.meta.shift_date) || new Date(data.today.updated||Date.now()).toLocaleTimeString(); }
    if(data.prior){ renderTable(el.prior, data.prior); el.hdrPrior.textContent=(data.prior.meta && data.prior.meta.shift_date) || new Date(data.prior.updated||Date.now()).toLocaleTimeString(); }
    if(data.week){ renderWeekMonth(el.week, data.week); el.hdrWeek.textContent=(data.week.meta && data.week.meta.range) || new Date(data.week.updated||Date.now()).toLocaleTimeString(); }
    if(data.month){ renderWeekMonth(el.month, data.month); el.hdrMonth.textContent=(data.month.meta && data.month.meta.range) || new Date(data.month.updated||Date.now()).toLocaleTimeString(); }
    el.ts.textContent='Fetched '+new Date().toLocaleTimeString();
    el.upd.textContent=new Date().toLocaleString();
  }

  async function fetchOnce(){
    try{
      const r = await fetch('data.json?t='+Date.now(), {cache:'no-cache'});
      const j = await r.json();
      apply(j);
    }catch(e){ console.error('fetch error', e); }
  }

  let interval = null;
  function startAuto(){ stopAuto(); interval = setInterval(fetchOnce, 60000); }
  function stopAuto(){ if(interval) clearInterval(interval); interval=null; }
  el.auto.onchange=()=>{ if(el.auto.checked) startAuto(); else stopAuto(); };
  el.refresh.onclick=()=> fetchOnce();
  // No dynamic font autosize with tables; no resize handler needed

  // initial
  fetchOnce(); startAuto();
</script>

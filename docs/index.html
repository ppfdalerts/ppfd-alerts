<!doctype html>
<meta name=viewport content="width=device-width, initial-scale=1">
<title>PPFD Live Leaderboards</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#151a20; --text:#e5e7eb; --muted:#9ca3af;
    --red:#ef4444; --gold:#f59e0b; --smoke:#374151; --accent:#ff7043;
    --green:#22c55e; --teal:#14b8a6; --blue:#3b82f6; --indigo:#6366f1;
  }
  *{box-sizing:border-box}
  html,body{height:100%; width:100%;}
  body{margin:0; background:linear-gradient(180deg, #0b0d10, #0e1216); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh; width:100vw; padding:8px 10px;}
  .toolbar{display:flex; align-items:center; gap:12px; margin:4px 0 8px;}
  .pill{background:#1f2937; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .btn{background:#1f2937; border:1px solid #111722; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer}
  .btn:hover{background:#223047}
  .canvas{position:relative; height:100%; width:100%;}
  .canvas.flow{display:grid; grid-template-columns: 1fr 1fr; grid-auto-rows:auto; gap:10px; align-content:start}
  .canvas.flow .panel{position:static !important; width:auto !important; height:auto !important}
  .panel{position:absolute; z-index:1; background:var(--panel); border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.35); overflow:hidden; border:1px solid #111722; display:flex; flex-direction:column; min-height:60px; min-width:120px}
  .panel .hdr{display:flex; align-items:center; gap:10px; padding:10px 12px; font-weight:700; letter-spacing:.3px; text-transform:uppercase; font-size:13px; flex:0 0 auto; border-bottom:1px solid #0f141a;}
  .panel .hdr .dot{width:10px; height:10px; border-radius:50%}
  .panel .hdr .sub{margin-left:auto; color:var(--muted); font-weight:500}
  .panel .body{margin:0; padding:0 12px 12px; overflow:auto}
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{position:sticky; top:0; background:#0f141a; color:#9ca3af; text-align:left; font-weight:700; padding:10px 6px; border-bottom:1px solid #1f2937}
  tbody td{padding:10px 6px; border-bottom:1px dashed #1f2732}
  tbody tr:nth-child(odd){background:rgba(255,255,255,0.015)}
  tbody tr:hover{background:#111722}
  #board-today tbody tr[data-unit], #board-prior tbody tr[data-unit]{cursor:pointer}
  #board-today tbody tr[data-unit] td:first-child, #board-prior tbody tr[data-unit] td:first-child{color:#bfdbfe}
  .col-unit{width:20%}
  .col-calls{width:16%}
  .col-avg{width:22%}
  .col-max{width:22%}
  .col-after{width:20%}
  /* Top 3 rows styling (applies to Today/Prior; Week/Month are suppressed below) */
  tr.rank-1 td{background:linear-gradient(90deg, rgba(245,158,11,.18), transparent);} /* gold */
  tr.rank-2 td{background:linear-gradient(90deg, rgba(192,192,192,.20), transparent);} /* silver */
  tr.rank-3 td{background:linear-gradient(90deg, rgba(205,127,50,.18), transparent);} /* bronze */
  .pill-badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px}
  .after-badge{background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35)}
  .calls-badge{background:rgba(34,197,94,.16); color:#bbf7d0; border:1px solid rgba(34,197,94,.35)}
  .avg-badge{background:rgba(59,130,246,.16); color:#bfdbfe; border:1px solid rgba(59,130,246,.35)}
  /* Shift colors for A/B/C values */
  .valA{ color: var(--blue); }
  .valB{ color: var(--red); }
  .valC{ color: var(--green); }
  /* Winner marker becomes a border around the number */
  .win{ display:inline; padding:0; border:0; border-radius:6px; line-height:inherit; }
  body.winners-on .win{ display:inline-block; padding:2px 6px; border:2px solid currentColor; }
  .grip{position:absolute; right:6px; bottom:6px; width:16px; height:16px; color:#728090; opacity:.35}
  .panel .hdr{cursor:default}
  body.edit-on .panel .hdr{cursor:move}
  body.edit-on .grip{opacity:.8}
  body.edit-on .panel{outline:1px dashed #2b3442}
  .grid{display:none}
  .timestamp{margin-left:auto; color:var(--muted); font-size:12px}
  .status{display:none; margin-left:8px; font-size:12px; background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35); padding:3px 8px; border-radius:999px}
  .footer{position:absolute; left:10px; bottom:8px; color:var(--muted); font-size:12px}
  .panel .hdr .dot.today{background:var(--gold)}
  .panel .hdr .dot.prior{background:var(--accent)}
  .panel .hdr .dot.week{background:var(--smoke)}
  .panel .hdr .dot.month{background:var(--teal)}
  .panel.shift-a{ border-color: rgba(59,130,246,.35); box-shadow:0 6px 16px rgba(59,130,246,.12); }
  .panel.shift-a .hdr{ background:rgba(59,130,246,.10); }
  .panel.shift-a .hdr .dot{ background: var(--blue); }
  .panel.shift-b{ border-color: rgba(239,68,68,.35); box-shadow:0 6px 16px rgba(239,68,68,.12); }
  .panel.shift-b .hdr{ background:rgba(239,68,68,.10); }
  .panel.shift-b .hdr .dot{ background: var(--red); }
  .panel.shift-c{ border-color: rgba(34,197,94,.35); box-shadow:0 6px 16px rgba(34,197,94,.12); }
  .panel.shift-c .hdr{ background:rgba(34,197,94,.10); }
  .panel.shift-c .hdr .dot{ background: var(--green); }
  .valA{ color: var(--blue); font-weight:600 }
  .valB{ color: var(--red); font-weight:600 }
  .valC{ color: var(--green); font-weight:600 }
  #board-week thead th[rowspan], #board-month thead th[rowspan]{ position: sticky; left: 0; z-index: 4; background:#0f141a; box-shadow: 2px 0 0 #0b1016; }
  #board-week tbody td:first-child, #board-month tbody td:first-child{ position: sticky; left: 0; z-index: 3; background: var(--panel); box-shadow: 2px 0 0 #0b1016; }
  /* Remove rank row backgrounds for week/month */
  #board-week tr.rank-1 td, #board-week tr.rank-2 td, #board-week tr.rank-3 td,
  #board-month tr.rank-1 td, #board-month tr.rank-2 td, #board-month tr.rank-3 td{ background:none }
  #board-week th, #board-week td, #board-month th, #board-month td{ border-right:1px solid #1f2937; }
  #board-week th:nth-child(1), #board-week td:nth-child(1),
  #board-week th:nth-child(4), #board-week td:nth-child(4),
  #board-week th:nth-child(7), #board-week td:nth-child(7),
  #board-week th:nth-child(10), #board-week td:nth-child(10),
  #board-week th:nth-child(13), #board-week td:nth-child(13),
  #board-week th:nth-child(16), #board-week td:nth-child(16),
  #board-week th:nth-child(19), #board-week td:nth-child(19),
  #board-month th:nth-child(1), #board-month td:nth-child(1),
  #board-month th:nth-child(4), #board-month td:nth-child(4),
  #board-month th:nth-child(7), #board-month td:nth-child(7),
  #board-month th:nth-child(10), #board-month td:nth-child(10),
  #board-month th:nth-child(13), #board-month td:nth-child(13),
  #board-month th:nth-child(16), #board-month td:nth-child(16),
  #board-month th:nth-child(19), #board-month td:nth-child(19) { border-right:2px solid #223047; }
  .roster-pop{position:absolute; z-index:9999; min-width:260px; max-width:420px; background:#0f141a; border:1px solid #223047; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.45); padding:10px 12px}
  .roster-pop .roster-head{display:flex; align-items:center; gap:8px; margin-bottom:8px}
  .roster-pop .roster-title{font-weight:700; letter-spacing:.3px}
  .roster-pop .roster-meta{margin-left:auto; color:var(--muted); font-size:12px}
  .roster-pop .roster-close{background:transparent; border:0; color:var(--muted); cursor:pointer; font-size:16px; line-height:16px; padding:2px 6px}
  .roster-pop .roster-body{max-height:320px; overflow:auto}
  .roster-section{border-top:1px dashed #1f2732; padding-top:8px; margin-top:8px}
  .roster-shift{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; margin-bottom:6px}
  .roster-entry{display:grid; grid-template-columns:86px 1fr; gap:8px; padding:4px 0; font-size:13px}
  .roster-entry .time{color:var(--accent); font-weight:700}
  .roster-entry .name{color:var(--text)}
  .roster-entry .meta{color:var(--muted); font-size:12px}
  .roster-empty{color:var(--muted); font-size:13px; padding:6px 0}
  #panel-personnel{display:none; z-index:5}
  body.personnel-on #panel-personnel{display:flex}
  .panel .hdr .dot.personnel{background:var(--indigo)}
  .personnel-controls{display:flex; gap:12px; align-items:center; margin:8px 0 10px; font-size:12px; color:var(--muted)}
  .personnel-controls label{display:flex; gap:6px; align-items:center}
  .personnel-controls select, .personnel-controls input{background:#0f141a; border:1px solid #223047; color:var(--text); padding:4px 6px; border-radius:6px; font-size:12px}
  .personnel-controls input{min-width:180px}
  .personnel-table th{cursor:pointer}
  .personnel-table th.sort-asc::after{content:" ▲"; color:var(--muted); font-size:11px}
  .personnel-table th.sort-desc::after{content:" ▼"; color:var(--muted); font-size:11px}
  @media (max-width: 900px){
    .wrap{padding:6px}
    .toolbar{gap:8px}
    .canvas{display:flex; flex-direction:column; gap:10px}
    .panel{position:static; width:100% !important; height:auto !important}
    body.edit-on .panel{position:absolute !important}
    .panel .hdr{font-size:12px; padding:10px}
    table{font-size:13px}
    thead th, tbody td{padding:8px 6px}
    .grip{display:none}
    body.edit-on .grip{display:block}
  }
</style>
<div class="wrap">
  <div class="toolbar">
    <div class="pill">PPFD Leaderboards</div>
    <div class="pill">Auto refresh
      <label style="margin-left:4px"><input id="auto" type="checkbox" checked></label>
    </div>
    <div class="pill">Edit layout<label style="margin-left:4px"><input id="edit" type="checkbox"></label></div>
    <div class="pill">Winners <label style="margin-left:4px"><input id="winners" type="checkbox" checked></label></div>
    <div class="pill">Roster active now <label style="margin-left:4px"><input id="rosterNow" type="checkbox"></label></div>
    <div class="pill">Personnel <label style="margin-left:4px"><input id="personnelToggle" type="checkbox"></label></div>
    <button id="resetLayout" class="btn">Reset layout</button>
    <button id="refresh" class="btn">Refresh now</button>
    <div id="status" class="status"></div><div id="ts" class="timestamp">—</div>
  </div>
  <div class="canvas">
    <div class="panel" id="panel-today" style="left:2vw; top:8vh; width:46vw; height:84vh">
      <div class="hdr"><span class="dot today"></span><span>Today</span><span id="hdr-today" class="sub">—</span></div>
      <div class="body"><table id="board-today"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-prior" style="left:50vw; top:8vh; width:46vw; height:30vh">
      <div class="hdr"><span class="dot prior"></span><span>Prior Shift</span><span id="hdr-prior" class="sub">—</span></div>
      <div class="body"><table id="board-prior"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-week" style="left:50vw; top:36vh; width:46vw; height:32vh">
      <div class="hdr"><span class="dot week"></span><span>Week</span><span id="hdr-week" class="sub">—</span></div>
      <div class="body"><table id="board-week"><thead>
        <tr>
          <th class="col-unit" rowspan="2">Unit</th>
          <th colspan="3">Total Calls</th>
          <th colspan="3">Single-Shift Max Calls</th>
          <th colspan="3">Avg. Call Duration (Mins)</th>
          <th colspan="3">Highest Call Duration (Mins)</th>
          <th colspan="3">Total Calls After Midnight</th>
          <th colspan="3">Single-Shift Max After Midnight</th>
        </tr>
        <tr>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
        </tr>
      </thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-month" style="left:50vw; top:70vh; width:46vw; height:24vh">
      <div class="hdr"><span class="dot month"></span><span>Month</span><span id="hdr-month" class="sub">—</span></div>
      <div class="body"><table id="board-month"><thead>
        <tr>
          <th class="col-unit" rowspan="2">Unit</th>
          <th colspan="3">Total Calls</th>
          <th colspan="3">Single-Shift Max Calls</th>
          <th colspan="3">Avg. Call Duration (Mins)</th>
          <th colspan="3">Highest Call Duration (Mins)</th>
          <th colspan="3">Total Calls After Midnight</th>
          <th colspan="3">Single-Shift Max After Midnight</th>
        </tr>
        <tr>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
        </tr>
      </thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-personnel" style="left:2vw; top:8vh; width:96vw; height:84vh">
      <div class="hdr"><span class="dot personnel"></span><span>Personnel</span><span id="hdr-personnel" class="sub">—</span></div>
      <div class="body">
        <div class="personnel-controls">
          <label>Period
            <select id="personnelPeriod">
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </label>
          <label>Filter
            <input id="personnelFilter" type="search" placeholder="Name or ID">
          </label>
        </div>
        <table id="board-personnel" class="personnel-table">
          <thead>
            <tr>
              <th data-sort="name">Name</th>
              <th data-sort="total_calls">Total Calls</th>
              <th data-sort="single_shift_max_calls">Single-Shift Max Calls</th>
              <th data-sort="avg_call_duration_mins">Avg. Call Duration (Mins)</th>
              <th data-sort="highest_call_duration_mins">Highest Call Duration (Mins)</th>
              <th data-sort="total_calls_after_midnight">Total Calls After Midnight</th>
              <th data-sort="single_shift_max_after_midnight">Single-Shift Max After Midnight</th>
              <th data-sort="total_call_hours">Total Call Hours</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="footer">Updated <span id="updated">—</span></div>
  </div>
</div>
<div id="rosterPop" class="roster-pop" style="display:none">
  <div class="roster-head">
    <div class="roster-title" id="rosterTitle">Unit</div>
    <div class="roster-meta" id="rosterMeta">Roster</div>
    <button id="rosterClose" class="roster-close" aria-label="Close roster">x</button>
  </div>
  <div class="roster-body" id="rosterBody"></div>
</div>
<script>
  const el = {
    today: document.getElementById('board-today'),
    prior: document.getElementById('board-prior'),
    week: document.getElementById('board-week'),
    month: document.getElementById('board-month'),
    hdrToday: document.getElementById('hdr-today'),
    hdrPrior: document.getElementById('hdr-prior'),
    hdrWeek: document.getElementById('hdr-week'),
    hdrMonth: document.getElementById('hdr-month'),
    ts: document.getElementById('ts'),
    upd: document.getElementById('updated'),
    status: document.getElementById('status'),
    auto: document.getElementById('auto'),
    edit: document.getElementById('edit'),
    resetLayout: document.getElementById('resetLayout'),
    refresh: document.getElementById('refresh'),
    winners: document.getElementById('winners'),
    rosterNow: document.getElementById('rosterNow'),
    personnelToggle: document.getElementById('personnelToggle'),
    personnel: document.getElementById('board-personnel'),
    personnelPeriod: document.getElementById('personnelPeriod'),
    personnelFilter: document.getElementById('personnelFilter'),
    hdrPersonnel: document.getElementById('hdr-personnel'),
    rosterPop: document.getElementById('rosterPop'),
    rosterTitle: document.getElementById('rosterTitle'),
    rosterMeta: document.getElementById('rosterMeta'),
    rosterBody: document.getElementById('rosterBody'),
    rosterClose: document.getElementById('rosterClose')
  };

  // Heartbeat + robust error surfacing so issues are visible without console
  (function(){
    function showStatus(msg, ok){
      try{
        if(!el || !el.status) return;
        el.status.style.display = 'inline-block';
        el.status.textContent = msg;
        // Light green for OK heartbeat, red for errors
        if(ok){
          el.status.style.background = 'rgba(34,197,94,.15)';
          el.status.style.color = '#bbf7d0';
          el.status.style.borderColor = 'rgba(34,197,94,.35)';
        } else {
          el.status.style.background = 'rgba(239,68,68,.15)';
          el.status.style.color = '#fecaca';
          el.status.style.borderColor = 'rgba(239,68,68,.35)';
        }
      }catch(_){/* noop */}
    }
    // Show that the JS executed at least up to here
    showStatus('JS OK (script running)', true);
    // Global error hooks to surface renderer errors
    window.addEventListener('error', function(e){
      var msg = 'JS Error: ' + (e && (e.message || e.error) || 'unknown');
      if(e && e.filename){
        var fn = (e.filename||'').split(/[\\\/]/).pop();
        msg += ' @' + fn + ':' + (e.lineno||'');
      }
      showStatus(msg, false);
    });
    window.addEventListener('unhandledrejection', function(e){
      var r = e && e.reason;
      var m = (r && (r.message || r)) || 'unknown';
      showStatus('Promise Error: ' + m, false);
    });
  })();

  function renderTable(table, data, rosterKey){
    var tbody = table.querySelector('tbody');
    tbody.innerHTML='';
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      var tr=document.createElement('tr');
      var td=document.createElement('td');
      td.colSpan=(table.querySelectorAll('thead th').length||4);
      td.textContent='No runs recorded.'; td.style.color='#9ca3af';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    var rows=data.rows;
    var maxC=Math.max.apply(null, rows.map(function(r){return r.calls||0;}));
    var minC=Math.min.apply(null, rows.map(function(r){return r.calls||0;}));
    function callsHeat(c){
      var n=(maxC===minC)?0.7:((c-minC)/(maxC-minC));
      var hue=200-Math.round(n*160);
      var alpha=0.22+0.28*n;
      return 'background: hsla('+hue+',85%,52%,'+alpha+'); color:#0b0d10; font-weight:700; border-radius:6px; padding:2px 8px; display:inline-block;';
    }
    rows.forEach(function(r, idx){
      var tr=document.createElement('tr');
      tr.dataset.unit = r.unit;
      if(idx===0) tr.classList.add('rank-1'); if(idx===1) tr.classList.add('rank-2'); if(idx===2) tr.classList.add('rank-3');
      if(rosterKey){
        tr.addEventListener('click', function(ev){
          ev.preventDefault();
          ev.stopPropagation();
          showRosterPopup(r.unit, rosterKey, ev);
        });
      }
      var tdU=document.createElement('td'); tdU.textContent=r.unit; tdU.className='col-unit'; tr.appendChild(tdU);
      var tdC=document.createElement('td'); tdC.className='col-calls'; tdC.innerHTML='<span class="pill-badge calls-badge" style="'+callsHeat(r.calls||0)+'">'+(r.calls||0)+'</span>'; tr.appendChild(tdC);
      var tdA=document.createElement('td'); tdA.className='col-avg'; tdA.innerHTML='<span class="pill-badge avg-badge">'+((r.avg_min||0).toFixed(1))+'</span>'; tr.appendChild(tdA);
      var thCount=table.querySelectorAll('thead th').length;
      if(thCount>=5){
        var tdX=document.createElement('td'); tdX.className='col-max';
        var show=(r.max_min&&r.max_min>0)? r.max_min.toFixed(1):'--';
        tdX.innerHTML='<span class="pill-badge avg-badge">'+show+'</span>';
        tr.appendChild(tdX);
      }
      var tdM=document.createElement('td'); tdM.className='col-after';
      var after=r.after_0000||0;
      if(after>0){ tdM.innerHTML='<span class="pill-badge after-badge">'+after+'</span>'; }
      else { tdM.textContent='0'; tdM.style.color='#9ca3af'; }
      tr.appendChild(tdM);
      tbody.appendChild(tr);
    });
  }

  function renderWeekMonth(table, data){
    var tbody=table.querySelector('tbody');
    tbody.innerHTML='';
    var thCount=19;
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      var tr=document.createElement('tr'); var td=document.createElement('td'); td.colSpan=thCount; td.textContent='No runs recorded.'; td.style.color='#9ca3af'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    function fnum(v,isFloat){ return isFloat ? ((isFinite(v)? Number(v).toFixed(1):'0.0')) : (v||0); }
    function winnerIndex(arr, lowest){
      var bestIdx=-1, bestVal=null;
      for(var i=0;i<3;i++){
        var v=Number((arr && arr[i]!=null) ? arr[i] : 0);
        if(lowest){
          if(!(v>0)) continue;
          if(bestIdx===-1 || v<bestVal){ bestVal=v; bestIdx=i; }
        } else {
          if(bestIdx===-1 || v>bestVal){ bestVal=v; bestIdx=i; }
        }
      }
      return bestIdx;
    }
    data.rows.forEach(function(r,idx){
      var tr=document.createElement('tr'); if(idx===0) tr.classList.add('rank-1'); if(idx===1) tr.classList.add('rank-2'); if(idx===2) tr.classList.add('rank-3');
      var tdU=document.createElement('td'); tdU.textContent=r.unit; tr.appendChild(tdU);
      (function(){
        var classes=['valA','valB','valC'];
        function renderGroup(arr, isFloat, lowestWins){
          var wi = winnerIndex(arr, lowestWins);
          for(var i=0;i<3;i++){
            var td=document.createElement('td'); td.className=classes[i];
            var t = fnum(((arr||[])[i]||0), isFloat);
            if(wi===i){ td.innerHTML = '<span class="win">'+t+'</span>'; } else { td.textContent = t; }
            tr.appendChild(td);
          }
        }
        renderGroup(r.calls_abc, false, false);
        renderGroup(r.calls_max_abc, false, false);
        renderGroup(r.avg_min_abc, true, true);
        renderGroup(r.max_min_abc, true, true);
        renderGroup(r.after_abc, false, false);
        renderGroup(r.after_max_abc, false, false);
      })();
      tbody.appendChild(tr);
    });
  }

  var rosterState = {
    payload: { today: null, prior: null },
    index: { today: null, prior: null },
    open: null
  };
  var personnelState = {
    data: { week: null, month: null },
    period: 'week',
    sortKey: 'total_calls',
    sortDir: 'desc',
    filter: ''
  };

  function normalizeUnitCode(code){
    var c=(code||'').toString().trim().toUpperCase();
    if(c.indexOf('DC')===0 && /^\d+$/.test(c.slice(2))){ return 'D'+c.slice(2); }
    return c;
  }

  function parseTimeToMinutes(value){
    if(value==null) return null;
    var text=String(value).trim();
    if(!text) return null;
    var m=/^(\d{1,2}):(\d{2})(?::\d{2})?\s*([AP]M)?$/i.exec(text);
    if(!m) return null;
    var hour=parseInt(m[1],10), minute=parseInt(m[2],10);
    var ap=m[3];
    if(ap){
      ap=ap.toUpperCase();
      if(ap==='PM' && hour!==12) hour+=12;
      if(ap==='AM' && hour===12) hour=0;
    }
    return (hour%24)*60+minute;
  }

  function coversTime(entry, atMinute){
    if(atMinute==null) return true;
    var start=parseTimeToMinutes(entry.from);
    var end=parseTimeToMinutes(entry.through);
    var hours=entry.hours;
    if(start==null || end==null) return true;
    if(start===end){
      var hoursVal=parseFloat(hours);
      if(!isFinite(hoursVal)) return true;
      if(hoursVal>=23.5) return true;
      var duration=Math.round(hoursVal*60);
      end=(start+duration)%(24*60);
    }
    if(start<end){ return start<=atMinute && atMinute<end; }
    return atMinute>=start || atMinute<end;
  }

  function formatShiftLabel(shiftText){
    if(!shiftText) return '';
    var parts=String(shiftText).split('/');
    return parts[parts.length-1].trim();
  }

  function buildRosterIndex(payload){
    var index={};
    if(!payload || !Array.isArray(payload.units)) return index;
    payload.units.forEach(function(unit){
      var code=normalizeUnitCode(unit.unit_code || unit.unit || '');
      if(!code) return;
      if(!index[code]) index[code]=[];
      if(code!==unit.unit_code){
        unit=Object.assign({}, unit, { unit_code: code });
      }
      index[code].push(unit);
    });
    return index;
  }

  function fetchRoster(){
    return fetch('roster_units.json?t='+Date.now(), {cache:'no-cache'})
      .then(function(r){ if(!r.ok) throw new Error('roster fetch'); return r.json(); })
      .then(function(j){
        var todayPayload = (j && j.today) ? j.today : j;
        var priorPayload = (j && j.prior) ? j.prior : null;
        rosterState.payload = { today: todayPayload, prior: priorPayload };
        rosterState.index.today = buildRosterIndex(todayPayload);
        rosterState.index.prior = priorPayload ? buildRosterIndex(priorPayload) : null;
        if(rosterState.open){ renderRosterPopup(rosterState.open.unit, rosterState.open.period); }
      })
      .catch(function(){
        rosterState.payload = { today: null, prior: null };
        rosterState.index = { today: null, prior: null };
      });
  }

  function nowMinutes(){
    var n=new Date();
    return n.getHours()*60+n.getMinutes();
  }

  function formatMinutes(mins){
    var h=Math.floor(mins/60)%24;
    var m=mins%60;
    return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
  }

  function renderRosterPopup(unitCode, period){
    if(!el.rosterPop) return;
    var code=normalizeUnitCode(unitCode);
    var periodKey = period || 'today';
    rosterState.open = { unit: code, period: periodKey };
    var useActive=!!(el.rosterNow && el.rosterNow.checked);
    var atMinute=useActive ? nowMinutes() : null;
    var payload = rosterState.payload && rosterState.payload[periodKey] ? rosterState.payload[periodKey] : null;
    var index = rosterState.index && rosterState.index[periodKey] ? rosterState.index[periodKey] : null;
    var rosterDate=payload && payload.date ? payload.date : '';
    var periodLabel = (periodKey === 'prior') ? 'Prior shift' : 'Today';
    var metaParts=[];
    if(rosterDate){ metaParts.push(rosterDate); }
    metaParts.push(periodLabel);
    metaParts.push(useActive ? ('Active '+formatMinutes(atMinute)) : 'All day');
    el.rosterTitle.textContent=code || 'Unit';
    el.rosterMeta.textContent=metaParts.join(' | ');
    el.rosterBody.innerHTML='';

    if(!payload || !index || !index[code]){
      var empty=document.createElement('div');
      empty.className='roster-empty';
      empty.textContent=(periodKey === 'prior') ? 'No roster data for the prior shift.' : 'No roster data for today.';
      el.rosterBody.appendChild(empty);
      return;
    }

    var sections=[];
    index[code].forEach(function(unit){
      var entries=Array.isArray(unit.entries) ? unit.entries.slice() : [];
      if(useActive){
        entries=entries.filter(function(e){ return coversTime(e, atMinute); });
      }
      entries.sort(function(a,b){
        var ta=parseTimeToMinutes(a.from) || 0;
        var tb=parseTimeToMinutes(b.from) || 0;
        return ta-tb;
      });
      if(entries.length){
        sections.push({ shift: formatShiftLabel(unit.shift), entries: entries, unit_name: unit.unit_name });
      }
    });

    if(!sections.length){
      var emptyNow=document.createElement('div');
      emptyNow.className='roster-empty';
      emptyNow.textContent=useActive ? 'No staffing active at this time.' : 'No staffing entries found.';
      el.rosterBody.appendChild(emptyNow);
      return;
    }

    sections.forEach(function(section, idx){
      var container=document.createElement('div');
      container.className=idx===0 ? '' : 'roster-section';
      if(section.shift){
        var shift=document.createElement('div');
        shift.className='roster-shift';
        shift.textContent=section.shift;
        container.appendChild(shift);
      }
      section.entries.forEach(function(entry){
        var row=document.createElement('div');
        row.className='roster-entry';
        var time=document.createElement('div');
        time.className='time';
        var from=entry.from || '--';
        var through=entry.through || '--';
        time.textContent=from+'-'+through;
        var detail=document.createElement('div');
        var name=document.createElement('div');
        name.className='name';
        name.textContent=entry.name || '-';
        var meta=document.createElement('div');
        meta.className='meta';
        var metaBits=[];
        if(entry.rank){ metaBits.push(entry.rank); }
        if(entry.id){ metaBits.push('ID '+entry.id); }
        if(entry.code){ metaBits.push(entry.code); }
        meta.textContent=metaBits.join(' | ');
        detail.appendChild(name);
        if(meta.textContent){ detail.appendChild(meta); }
        row.appendChild(time);
        row.appendChild(detail);
        container.appendChild(row);
      });
      el.rosterBody.appendChild(container);
    });
  }

  function positionRosterPopup(x, y){
    if(!el.rosterPop) return;
    var pad=12;
    var rect=el.rosterPop.getBoundingClientRect();
    var left=Math.min(x+pad, window.innerWidth-rect.width-pad);
    var top=Math.min(y+pad, window.innerHeight-rect.height-pad);
    el.rosterPop.style.left=Math.max(pad,left)+'px';
    el.rosterPop.style.top=Math.max(pad,top)+'px';
  }

  function showRosterPopup(unitCode, period, evt){
    if(!el.rosterPop) return;
    renderRosterPopup(unitCode, period);
    el.rosterPop.style.display='block';
    var x=evt && evt.clientX != null ? evt.clientX : window.innerWidth/2;
    var y=evt && evt.clientY != null ? evt.clientY : window.innerHeight/2;
    positionRosterPopup(x, y);
  }

  function closeRosterPopup(){
    if(!el.rosterPop) return;
    el.rosterPop.style.display='none';
    rosterState.open=null;
  }

  var personnelSortTypes = {
    name: 'string',
    total_calls: 'number',
    single_shift_max_calls: 'number',
    avg_call_duration_mins: 'number',
    highest_call_duration_mins: 'number',
    total_calls_after_midnight: 'number',
    single_shift_max_after_midnight: 'number',
    total_call_hours: 'number'
  };

  function updatePersonnelSortIndicators(){
    if(!el.personnel) return;
    var headers = el.personnel.querySelectorAll('thead th[data-sort]');
    headers.forEach(function(th){
      th.classList.remove('sort-asc', 'sort-desc');
      if(th.dataset.sort === personnelState.sortKey){
        th.classList.add(personnelState.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    });
  }

  function renderPersonnelTable(){
    if(!el.personnel) return;
    var tbody = el.personnel.querySelector('tbody');
    if(!tbody) return;
    var data = personnelState.data && personnelState.data[personnelState.period];
    var rows = (data && Array.isArray(data.rows)) ? data.rows.slice() : [];
    var filter = (personnelState.filter || '').trim().toLowerCase();
    if(filter){
      rows = rows.filter(function(r){
        var name = String(r.name || '').toLowerCase();
        var pid = String(r.person_id || '').toLowerCase();
        return name.indexOf(filter) !== -1 || pid.indexOf(filter) !== -1;
      });
    }
    var sortKey = personnelState.sortKey;
    var sortDir = personnelState.sortDir;
    var sortType = personnelSortTypes[sortKey] || 'number';
    rows.sort(function(a,b){
      var av = (a && a[sortKey] != null) ? a[sortKey] : (sortType === 'string' ? '' : 0);
      var bv = (b && b[sortKey] != null) ? b[sortKey] : (sortType === 'string' ? '' : 0);
      if(sortType === 'string'){
        av = String(av).toLowerCase();
        bv = String(bv).toLowerCase();
        if(av < bv) return sortDir === 'asc' ? -1 : 1;
        if(av > bv) return sortDir === 'asc' ? 1 : -1;
        return 0;
      }
      av = Number(av) || 0;
      bv = Number(bv) || 0;
      return sortDir === 'asc' ? (av - bv) : (bv - av);
    });

    tbody.innerHTML = '';
    if(!rows.length){
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = (el.personnel.querySelectorAll('thead th').length || 8);
      td.textContent = 'No personnel stats available.';
      td.style.color = '#9ca3af';
      tr.appendChild(td);
      tbody.appendChild(tr);
      if(el.hdrPersonnel){ el.hdrPersonnel.textContent = (data && data.meta && data.meta.range) ? data.meta.range : '—'; }
      updatePersonnelSortIndicators();
      return;
    }

    rows.forEach(function(r, idx){
      var tr = document.createElement('tr');
      if(idx===0) tr.classList.add('rank-1'); if(idx===1) tr.classList.add('rank-2'); if(idx===2) tr.classList.add('rank-3');
      function addCell(text){
        var td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      }
      addCell(r.name || r.person_id || '');
      addCell(String(r.total_calls || 0));
      addCell(String(r.single_shift_max_calls || 0));
      addCell((r.avg_call_duration_mins != null ? Number(r.avg_call_duration_mins).toFixed(1) : '0.0'));
      addCell((r.highest_call_duration_mins != null ? Number(r.highest_call_duration_mins).toFixed(1) : '0.0'));
      addCell(String(r.total_calls_after_midnight || 0));
      addCell(String(r.single_shift_max_after_midnight || 0));
      addCell((r.total_call_hours != null ? Number(r.total_call_hours).toFixed(1) : '0.0'));
      tbody.appendChild(tr);
    });

    if(el.hdrPersonnel){ el.hdrPersonnel.textContent = (data && data.meta && data.meta.range) ? data.meta.range : '—'; }
    updatePersonnelSortIndicators();
  }

  function applyPersonnel(personnel){
    if(!personnel) return;
    personnelState.data.week = personnel.week || null;
    personnelState.data.month = personnel.month || null;
    if(!personnelState.data[personnelState.period] && personnelState.data.month){
      personnelState.period = 'month';
      if(el.personnelPeriod){ el.personnelPeriod.value = 'month'; }
    }
    renderPersonnelTable();
  }

  function setPanelShift(panelId, letter){ var p=document.getElementById(panelId); if(!p||!letter) return; p.classList.remove('shift-a','shift-b','shift-c'); var l=(letter+'').toUpperCase(); if(l==='A') p.classList.add('shift-a'); if(l==='B') p.classList.add('shift-b'); if(l==='C') p.classList.add('shift-c'); }
  function letterFromMeta(meta){ if(!meta||!meta.shift_date) return ''; var m=/^([ABC])\-Shift\s/.exec(meta.shift_date.trim()); return m? m[1]:''; }

  function apply(data){
    var errors=[]; function safe(label,fn){ try{ fn(); } catch(e){ console.error('render error',label,e); errors.push(label); } }
    if(data.today){ safe('Today', function(){ renderTable(el.today, data.today, 'today'); el.hdrToday.textContent=(data.today.meta&&data.today.meta.shift_date)||new Date(data.today.updated||Date.now()).toLocaleTimeString(); setPanelShift('panel-today', letterFromMeta(data.today.meta)); }); }
    if(data.prior){ safe('Prior', function(){ renderTable(el.prior, data.prior, 'prior'); el.hdrPrior.textContent=(data.prior.meta&&data.prior.meta.shift_date)||new Date(data.prior.updated||Date.now()).toLocaleTimeString(); setPanelShift('panel-prior', letterFromMeta(data.prior.meta)); }); }
    if(data.week){ safe('Week', function(){ renderWeekMonth(el.week, data.week); el.hdrWeek.textContent=(data.week.meta&&data.week.meta.range)||new Date(data.week.updated||Date.now()).toLocaleTimeString(); }); }
    if(data.month){ safe('Month', function(){ renderWeekMonth(el.month, data.month); el.hdrMonth.textContent=(data.month.meta&&data.month.meta.range)||new Date(data.month.updated||Date.now()).toLocaleTimeString(); }); }
    if(data.personnel){ safe('Personnel', function(){ applyPersonnel(data.personnel); }); }
    el.ts.textContent='Fetched '+new Date().toLocaleTimeString(); el.upd.textContent=new Date().toLocaleString();
    if(errors.length){ el.status.style.display='inline-block'; el.status.textContent='Render error: '+errors.join(', '); el.status.title='One or more panels failed to render'; } else { el.status.style.display='none'; el.status.textContent=''; el.status.title=''; }
  }

  async function fetchOnce(){
    try{
      var r=await fetch('data.json?t='+Date.now(), {cache:'no-cache'});
      if(!r.ok){ el.status.style.display='inline-block'; el.status.textContent='Fetch error: '+r.status+' '+r.statusText; return; }
      var j=await r.json(); if(!j || (!j.today && !j.week && !j.prior && !j.month)){ el.status.style.display='inline-block'; el.status.textContent='No data in payload'; return; }
      apply(j);
    }catch(e){ console.error('fetch error', e); el.status.style.display='inline-block'; el.status.textContent='Fetch error (network/parse)'; }
    fetchRoster();
  }

  var interval=null; function startAuto(){ stopAuto(); interval=setInterval(fetchOnce, 60000); } function stopAuto(){ if(interval) clearInterval(interval); interval=null; }
  el.auto.onchange=function(){ if(el.auto.checked) startAuto(); else stopAuto(); };
  el.refresh.onclick=function(){ fetchOnce(); };
el.winners.onchange=function(){ document.body.classList.toggle('winners-on', el.winners.checked); };
  if(el.rosterNow){
    el.rosterNow.onchange=function(){
      if(rosterState.open){ renderRosterPopup(rosterState.open.unit, rosterState.open.period); }
    };
  }
  if(el.personnelToggle){
    try{
      var saved = localStorage.getItem('ppfd_personnel_on');
      if(saved === '1'){ el.personnelToggle.checked = true; }
    }catch(_){}
    document.body.classList.toggle('personnel-on', !!el.personnelToggle.checked);
    el.personnelToggle.onchange=function(){
      document.body.classList.toggle('personnel-on', !!el.personnelToggle.checked);
      try{ localStorage.setItem('ppfd_personnel_on', el.personnelToggle.checked ? '1' : '0'); }catch(_){}
      renderPersonnelTable();
    };
  }
  if(el.personnelPeriod){
    el.personnelPeriod.onchange=function(){
      personnelState.period = el.personnelPeriod.value || 'week';
      renderPersonnelTable();
    };
  }
  if(el.personnelFilter){
    el.personnelFilter.oninput=function(){
      personnelState.filter = el.personnelFilter.value || '';
      renderPersonnelTable();
    };
  }
  if(el.personnel){
    var headers = el.personnel.querySelectorAll('thead th[data-sort]');
    headers.forEach(function(th){
      th.addEventListener('click', function(){
        var key = th.dataset.sort;
        if(!key) return;
        if(personnelState.sortKey === key){
          personnelState.sortDir = personnelState.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          personnelState.sortKey = key;
          personnelState.sortDir = (key === 'name') ? 'asc' : 'desc';
        }
        renderPersonnelTable();
      });
    });
  }

  if(el.rosterClose){
    el.rosterClose.onclick=function(e){
      e.stopPropagation();
      closeRosterPopup();
    };
  }
  document.addEventListener('click', function(e){
    if(!el.rosterPop || el.rosterPop.style.display==='none') return;
    if(el.rosterPop.contains(e.target)) return;
    closeRosterPopup();
  });
  document.addEventListener('keydown', function(e){
    if(e.key==='Escape'){ closeRosterPopup(); }
  });

  var panels={ today:document.getElementById('panel-today'), prior:document.getElementById('panel-prior'), week:document.getElementById('panel-week'), month:document.getElementById('panel-month'), personnel:document.getElementById('panel-personnel') };
  var defaultLayout={ today:{left:2,top:8,width:46,height:60}, prior:{left:2,top:70,width:46,height:28}, week:{left:50,top:8,width:48,height:40}, month:{left:50,top:50,width:48,height:48}, personnel:{left:2,top:8,width:96,height:84} };
  function loadLayout(){ try{ var j=JSON.parse(localStorage.getItem('ppfd_layout_v1')||'{}'); var out={}; for(var k in defaultLayout){ out[k]=defaultLayout[k]; } for(var k2 in j){ out[k2]=j[k2]; } return out; }catch(e){ var d={}; for(var k3 in defaultLayout){ d[k3]=defaultLayout[k3]; } return d; } }
  function saveLayout(l){ try{ localStorage.setItem('ppfd_layout_v1', JSON.stringify(l)); }catch(e){} }
  function isDefaultLayout(l){ var tol=0.001; for(var k in defaultLayout){ var a=l[k]||defaultLayout[k], b=defaultLayout[k]; var keys=['left','top','width','height']; for(var i=0;i<keys.length;i++){ var key=keys[i]; if(Math.abs(((a[key]||0)-(b[key]||0)))>tol) return false; } } return true; }
  function applyLayout(l){ for(var k in panels){ var p=panels[k]; var r=l[k]||defaultLayout[k]; p.style.left=r.left+'vw'; p.style.top=r.top+'vh'; p.style.width=r.width+'vw'; p.style.height=r.height+'vh'; } }
  function enableEditing(on){ document.body.classList.toggle('edit-on', !!on); }
  var layoutState={ current: loadLayout() };
  applyLayout(layoutState.current); enableEditing(false); document.body.classList.toggle('winners-on', el.winners && el.winners.checked);
  function updateFlowMode(){ var isMobile=window.matchMedia('(max-width: 900px)').matches; var canvas=document.querySelector('.canvas'); if(!canvas) return; if(!el.edit.checked && isDefaultLayout(layoutState.current) && !isMobile){ canvas.classList.add('flow'); for(var k in panels){ var p=panels[k]; p.style.left=''; p.style.top=''; p.style.width=''; p.style.height=''; } } else { canvas.classList.remove('flow'); applyLayout(layoutState.current); } }
  updateFlowMode();
  function attachDragResize(key){ var node=panels[key]; var handle=node.querySelector('.hdr'); var grip=node.querySelector('.grip'); var state={drag:false,size:false,sx:0,sy:0,start:null}; function downDrag(e){ if(!el.edit.checked) return; state.drag=true; state.sx=e.clientX; state.sy=e.clientY; var r=layoutState.current[key]||defaultLayout[key]; state.start={left:r.left,top:r.top,width:r.width,height:r.height}; e.preventDefault(); } function downSize(e){ if(!el.edit.checked) return; state.size=true; state.sx=e.clientX; state.sy=e.clientY; var r=layoutState.current[key]||defaultLayout[key]; state.start={left:r.left,top:r.top,width:r.width,height:r.height}; e.preventDefault(); } function move(e){ if(!(state.drag||state.size)) return; var vw=innerWidth, vh=innerHeight; var dx=(e.clientX-state.sx)/vw*100; var dy=(e.clientY-state.sy)/vh*100; var r=layoutState.current[key]||(layoutState.current[key]={left:defaultLayout[key].left,top:defaultLayout[key].top,width:defaultLayout[key].width,height:defaultLayout[key].height}); if(state.drag){ r.left=Math.max(0, Math.min(100-r.width, state.start.left+dx)); r.top=Math.max(0, Math.min(100-r.height, state.start.top+dy)); } if(state.size){ r.width=Math.min(100-r.left, Math.max(20, state.start.width+dx)); r.height=Math.min(100-r.top, Math.max(20, state.start.height+dy)); } applyLayout(layoutState.current); } function up(){ if(!(state.drag||state.size)) return; state.drag=false; state.size=false; saveLayout(layoutState.current); } handle.addEventListener('mousedown', downDrag); grip.addEventListener('mousedown', downSize); window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); handle.addEventListener('touchstart', function(ev){downDrag(ev.touches[0])}); grip.addEventListener('touchstart', function(ev){downSize(ev.touches[0])}); window.addEventListener('touchmove', function(ev){move(ev.touches[0])}); window.addEventListener('touchend', up); }
  attachDragResize('today'); attachDragResize('prior'); attachDragResize('week'); attachDragResize('month'); attachDragResize('personnel');
  el.edit.onchange=function(){ enableEditing(el.edit.checked); updateFlowMode(); };
  el.resetLayout.onclick=function(){ layoutState.current={today:{left:2,top:8,width:46,height:60}, prior:{left:2,top:70,width:46,height:28}, week:{left:50,top:8,width:48,height:40}, month:{left:50,top:50,width:48,height:48}, personnel:{left:2,top:8,width:96,height:84}}; saveLayout(layoutState.current); applyLayout(layoutState.current); updateFlowMode(); };
  window.addEventListener('resize', updateFlowMode);
  fetchOnce(); startAuto();
</script>

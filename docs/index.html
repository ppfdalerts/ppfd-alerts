<!doctype html>
<meta name=viewport content="width=device-width, initial-scale=1">
<title>PPFD Live Leaderboards</title>
<style>
  :root{ --bg:#0b0d10; --panel:#151a20; --text:#e5e7eb; --muted:#9ca3af; --red:#cf1020; --gold:#ffc107; --smoke:#374151; --accent:#ff7043; }
  *{box-sizing:border-box}
  html,body{height:100%; width:100%;}
  body{margin:0; background:linear-gradient(180deg, #0b0d10, #0e1216); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh; width:100vw; padding:8px 10px;}
  .toolbar{display:flex; align-items:center; gap:12px; margin:4px 0 8px;}
  .pill{background:#1f2937; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .btn{background:#1f2937; border:1px solid #111722; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer}
  .btn:hover{background:#223047}
  .canvas{position:relative; height:100%; width:100%;}
  .panel{position:absolute; background:var(--panel); border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.35); overflow:hidden; border:1px solid #111722; display:flex; flex-direction:column; min-height:60px; min-width:120px}
  .panel .hdr{display:flex; align-items:center; gap:10px; padding:10px 12px; font-weight:600; letter-spacing:.3px; text-transform:uppercase; font-size:13px; flex:0 0 auto;}
  .panel .hdr .dot{width:10px; height:10px; border-radius:50%}
  .panel .hdr .sub{margin-left:auto; color:var(--muted); font-weight:500}
  .panel .body{margin:0; padding:0 12px 12px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{position:sticky; top:0; background:#0f141a; color:#9ca3af; text-align:left; font-weight:600; padding:8px 6px; border-bottom:1px solid #1f2937}
  tbody td{padding:8px 6px; border-bottom:1px dashed #1f2732}
  tbody tr:hover{background:#111722}
  .col-unit{width:25%}
  .col-calls{width:20%}
  .col-avg{width:25%}
  .col-after{width:30%}
  .grip{position:absolute; right:6px; bottom:6px; width:16px; height:16px; color:#728090; opacity:.35}
  .grid{display:none}
  .timestamp{margin-left:auto; color:var(--muted); font-size:12px}
  .footer{position:absolute; left:10px; bottom:8px; color:var(--muted); font-size:12px}
  .panel .hdr .dot.today{background:var(--gold)}
  .panel .hdr .dot.prior{background:var(--accent)}
  .panel .hdr .dot.week{background:var(--smoke)}
</style>
<div class="wrap">
  <div class="toolbar">
    <div class="pill">PPFD Leaderboards</div>
    <div class="pill">Auto refresh
      <label style="margin-left:4px"><input id="auto" type="checkbox" checked></label>
    </div>
    <button id="refresh" class="btn">Refresh now</button>
    <div id="ts" class="timestamp">—</div>
  </div>
  <div class="canvas">
    <div class="panel" id="panel-today" style="left:2vw; top:8vh; width:46vw; height:84vh">
      <div class="hdr"><span class="dot today"></span><span>Today</span><span id="hdr-today" class="sub">—</span></div>
      <div class="body"><table id="board-today"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg (min)</th><th class="col-after">After 00:00</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-prior" style="left:50vw; top:8vh; width:46vw; height:40vh">
      <div class="hdr"><span class="dot prior"></span><span>Prior Shift</span><span id="hdr-prior" class="sub">—</span></div>
      <div class="body"><table id="board-prior"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg (min)</th><th class="col-after">After 00:00</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-week" style="left:50vw; top:52vh; width:46vw; height:40vh">
      <div class="hdr"><span class="dot week"></span><span>Week</span><span id="hdr-week" class="sub">—</span></div>
      <div class="body"><table id="board-week"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg (min)</th><th class="col-after">After 00:00</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="footer">Updated <span id="updated">—</span></div>
  </div>
</div>
<script>
  const el = {
    today: document.getElementById('board-today'),
    prior: document.getElementById('board-prior'),
    week: document.getElementById('board-week'),
    hdrToday: document.getElementById('hdr-today'),
    hdrPrior: document.getElementById('hdr-prior'),
    hdrWeek: document.getElementById('hdr-week'),
    ts: document.getElementById('ts'),
    upd: document.getElementById('updated'),
    auto: document.getElementById('auto'),
    refresh: document.getElementById('refresh')
  };

  function renderTable(table, data){
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      const tr=document.createElement('tr');
      const td=document.createElement('td'); td.colSpan=4; td.textContent='No runs recorded.'; td.style.color='#9ca3af'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const r of data.rows){
      const tr=document.createElement('tr');
      const tdU=document.createElement('td'); tdU.textContent=r.unit; tdU.className='col-unit'; tr.appendChild(tdU);
      const tdC=document.createElement('td'); tdC.textContent=r.calls; tdC.className='col-calls'; tr.appendChild(tdC);
      const tdA=document.createElement('td'); tdA.textContent=r.avg_min.toFixed(1); tdA.className='col-avg'; tr.appendChild(tdA);
      const tdM=document.createElement('td'); tdM.textContent=r.after_0000; tdM.className='col-after'; tr.appendChild(tdM);
      tbody.appendChild(tr);
    }
  }

  function apply(data){
    if(data.today){ renderTable(el.today, data.today); el.hdrToday.textContent=new Date(data.today.updated||Date.now()).toLocaleTimeString(); }
    if(data.prior){ renderTable(el.prior, data.prior); el.hdrPrior.textContent=new Date(data.prior.updated||Date.now()).toLocaleTimeString(); }
    if(data.week){ renderTable(el.week, data.week); el.hdrWeek.textContent=new Date(data.week.updated||Date.now()).toLocaleTimeString(); }
    el.ts.textContent='Fetched '+new Date().toLocaleTimeString();
    el.upd.textContent=new Date().toLocaleString();
  }

  async function fetchOnce(){
    try{
      const r = await fetch('data.json?t='+Date.now(), {cache:'no-cache'});
      const j = await r.json();
      apply(j);
    }catch(e){ console.error('fetch error', e); }
  }

  let interval = null;
  function startAuto(){ stopAuto(); interval = setInterval(fetchOnce, 60000); }
  function stopAuto(){ if(interval) clearInterval(interval); interval=null; }
  el.auto.onchange=()=>{ if(el.auto.checked) startAuto(); else stopAuto(); };
  el.refresh.onclick=()=> fetchOnce();
  window.addEventListener('resize', fitAll);

  // initial
  fetchOnce(); startAuto();
</script>

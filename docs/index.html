<!doctype html>
<meta name=viewport content="width=device-width, initial-scale=1">
<title>PPFD Live Leaderboards</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#151a20; --text:#e5e7eb; --muted:#9ca3af;
    --red:#ef4444; --gold:#f59e0b; --smoke:#374151; --accent:#ff7043;
    --green:#22c55e; --teal:#14b8a6; --blue:#3b82f6; --indigo:#6366f1;
  }
  *{box-sizing:border-box}
  html,body{height:100%; width:100%;}
  body{margin:0; background:linear-gradient(180deg, #0b0d10, #0e1216); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .wrap{display:grid; grid-template-rows:auto 1fr; height:100vh; width:100vw; padding:8px 10px;}
  .toolbar{display:flex; align-items:center; gap:12px; margin:4px 0 8px;}
  .pill{background:#1f2937; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .btn{background:#1f2937; border:1px solid #111722; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer}
  .btn:hover{background:#223047}
  .canvas{position:relative; height:100%; width:100%;}
  .canvas.flow{display:grid; grid-template-columns: 1fr 1fr; grid-auto-rows:auto; gap:10px; align-content:start}
  .canvas.flow .panel{position:static !important; width:auto !important; height:auto !important}
  .panel{position:absolute; background:var(--panel); border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,.35); overflow:hidden; border:1px solid #111722; display:flex; flex-direction:column; min-height:60px; min-width:120px}
  .panel .hdr{display:flex; align-items:center; gap:10px; padding:10px 12px; font-weight:700; letter-spacing:.3px; text-transform:uppercase; font-size:13px; flex:0 0 auto; border-bottom:1px solid #0f141a;}
  .panel .hdr .dot{width:10px; height:10px; border-radius:50%}
  .panel .hdr .sub{margin-left:auto; color:var(--muted); font-weight:500}
  .panel .body{margin:0; padding:0 12px 12px; overflow:auto}
  table{width:100%; border-collapse:collapse; font-size:14px}
  thead th{position:sticky; top:0; background:#0f141a; color:#9ca3af; text-align:left; font-weight:700; padding:10px 6px; border-bottom:1px solid #1f2937}
  tbody td{padding:10px 6px; border-bottom:1px dashed #1f2732}
  tbody tr:nth-child(odd){background:rgba(255,255,255,0.015)}
  tbody tr:hover{background:#111722}
  .col-unit{width:20%}
  .col-calls{width:16%}
  .col-avg{width:22%}
  .col-max{width:22%}
  .col-after{width:20%}
  /* Top 3 rows styling (applies to Today/Prior; Week/Month are suppressed below) */
  tr.rank-1 td{background:linear-gradient(90deg, rgba(245,158,11,.18), transparent);} /* gold */
  tr.rank-2 td{background:linear-gradient(90deg, rgba(192,192,192,.20), transparent);} /* silver */
  tr.rank-3 td{background:linear-gradient(90deg, rgba(205,127,50,.18), transparent);} /* bronze */
  .pill-badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:18px}
  .after-badge{background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35)}
  .calls-badge{background:rgba(34,197,94,.16); color:#bbf7d0; border:1px solid rgba(34,197,94,.35)}
  .avg-badge{background:rgba(59,130,246,.16); color:#bfdbfe; border:1px solid rgba(59,130,246,.35)}
  /* Winner marker */
  .win{width:8px;height:8px;border-radius:2px;display:inline-block;margin-right:6px;background:currentColor;border:1px solid currentColor;vertical-align:middle}
  body:not(.winners-on) .win{display:none}
  .grip{position:absolute; right:6px; bottom:6px; width:16px; height:16px; color:#728090; opacity:.35}
  .panel .hdr{cursor:default}
  body.edit-on .panel .hdr{cursor:move}
  body.edit-on .grip{opacity:.8}
  body.edit-on .panel{outline:1px dashed #2b3442}
  .grid{display:none}
  .timestamp{margin-left:auto; color:var(--muted); font-size:12px}
  .status{display:none; margin-left:8px; font-size:12px; background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.35); padding:3px 8px; border-radius:999px}
  .footer{position:absolute; left:10px; bottom:8px; color:var(--muted); font-size:12px}
  .panel .hdr .dot.today{background:var(--gold)}
  .panel .hdr .dot.prior{background:var(--accent)}
  .panel .hdr .dot.week{background:var(--smoke)}
  .panel .hdr .dot.month{background:var(--teal)}
  .panel.shift-a{ border-color: rgba(59,130,246,.35); box-shadow:0 6px 16px rgba(59,130,246,.12); }
  .panel.shift-a .hdr{ background:rgba(59,130,246,.10); }
  .panel.shift-a .hdr .dot{ background: var(--blue); }
  .panel.shift-b{ border-color: rgba(239,68,68,.35); box-shadow:0 6px 16px rgba(239,68,68,.12); }
  .panel.shift-b .hdr{ background:rgba(239,68,68,.10); }
  .panel.shift-b .hdr .dot{ background: var(--red); }
  .panel.shift-c{ border-color: rgba(34,197,94,.35); box-shadow:0 6px 16px rgba(34,197,94,.12); }
  .panel.shift-c .hdr{ background:rgba(34,197,94,.10); }
  .panel.shift-c .hdr .dot{ background: var(--green); }
  .valA{ color: var(--blue); font-weight:600 }
  .valB{ color: var(--red); font-weight:600 }
  .valC{ color: var(--green); font-weight:600 }
  #board-week thead th[rowspan], #board-month thead th[rowspan]{ position: sticky; left: 0; z-index: 4; background:#0f141a; box-shadow: 2px 0 0 #0b1016; }
  #board-week tbody td:first-child, #board-month tbody td:first-child{ position: sticky; left: 0; z-index: 3; background: var(--panel); box-shadow: 2px 0 0 #0b1016; }
  /* Remove rank row backgrounds for week/month */
  #board-week tr.rank-1 td, #board-week tr.rank-2 td, #board-week tr.rank-3 td,
  #board-month tr.rank-1 td, #board-month tr.rank-2 td, #board-month tr.rank-3 td{ background:none }
  #board-week th, #board-week td, #board-month th, #board-month td{ border-right:1px solid #1f2937; }
  #board-week th:nth-child(1), #board-week td:nth-child(1),
  #board-week th:nth-child(4), #board-week td:nth-child(4),
  #board-week th:nth-child(7), #board-week td:nth-child(7),
  #board-week th:nth-child(10), #board-week td:nth-child(10),
  #board-week th:nth-child(13), #board-week td:nth-child(13),
  #board-week th:nth-child(16), #board-week td:nth-child(16),
  #board-week th:nth-child(19), #board-week td:nth-child(19),
  #board-month th:nth-child(1), #board-month td:nth-child(1),
  #board-month th:nth-child(4), #board-month td:nth-child(4),
  #board-month th:nth-child(7), #board-month td:nth-child(7),
  #board-month th:nth-child(10), #board-month td:nth-child(10),
  #board-month th:nth-child(13), #board-month td:nth-child(13),
  #board-month th:nth-child(16), #board-month td:nth-child(16),
  #board-month th:nth-child(19), #board-month td:nth-child(19) { border-right:2px solid #223047; }
  @media (max-width: 900px){
    .wrap{padding:6px}
    .toolbar{gap:8px}
    .canvas{display:flex; flex-direction:column; gap:10px}
    .panel{position:static; width:100% !important; height:auto !important}
    body.edit-on .panel{position:absolute !important}
    .panel .hdr{font-size:12px; padding:10px}
    table{font-size:13px}
    thead th, tbody td{padding:8px 6px}
    .grip{display:none}
    body.edit-on .grip{display:block}
  }
</style>
<div class="wrap">
  <div class="toolbar">
    <div class="pill">PPFD Leaderboards</div>
    <div class="pill">Auto refresh
      <label style="margin-left:4px"><input id="auto" type="checkbox" checked></label>
    </div>
    <div class="pill">Edit layout<label style="margin-left:4px"><input id="edit" type="checkbox"></label></div>
    <div class="pill">Winners <label style="margin-left:4px"><input id="winners" type="checkbox" checked></label></div>
    <button id="resetLayout" class="btn">Reset layout</button>
    <button id="refresh" class="btn">Refresh now</button>
    <div id="status" class="status"></div><div id="ts" class="timestamp">—</div>
  </div>
  <div class="canvas">
    <div class="panel" id="panel-today" style="left:2vw; top:8vh; width:46vw; height:84vh">
      <div class="hdr"><span class="dot today"></span><span>Today</span><span id="hdr-today" class="sub">—</span></div>
      <div class="body"><table id="board-today"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-prior" style="left:50vw; top:8vh; width:46vw; height:30vh">
      <div class="hdr"><span class="dot prior"></span><span>Prior Shift</span><span id="hdr-prior" class="sub">—</span></div>
      <div class="body"><table id="board-prior"><thead><tr><th class="col-unit">Unit</th><th class="col-calls">Calls</th><th class="col-avg">Avg. Time On Call (min)</th><th class="col-max">Highest Time On Call (min)</th><th class="col-after">Calls After Midnight</th></tr></thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-week" style="left:50vw; top:36vh; width:46vw; height:32vh">
      <div class="hdr"><span class="dot week"></span><span>Week</span><span id="hdr-week" class="sub">—</span></div>
      <div class="body"><table id="board-week"><thead>
        <tr>
          <th class="col-unit" rowspan="2">Unit</th>
          <th colspan="3">Total Calls</th>
          <th colspan="3">Single-Shift Max Calls</th>
          <th colspan="3">Avg. Call Duration (Mins)</th>
          <th colspan="3">Highest Call Duration (Mins)</th>
          <th colspan="3">Total Calls After Midnight</th>
          <th colspan="3">Single-Shift Max After Midnight</th>
        </tr>
        <tr>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
        </tr>
      </thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="panel" id="panel-month" style="left:50vw; top:70vh; width:46vw; height:24vh">
      <div class="hdr"><span class="dot month"></span><span>Month</span><span id="hdr-month" class="sub">—</span></div>
      <div class="body"><table id="board-month"><thead>
        <tr>
          <th class="col-unit" rowspan="2">Unit</th>
          <th colspan="3">Total Calls</th>
          <th colspan="3">Single-Shift Max Calls</th>
          <th colspan="3">Avg. Call Duration (Mins)</th>
          <th colspan="3">Highest Call Duration (Mins)</th>
          <th colspan="3">Total Calls After Midnight</th>
          <th colspan="3">Single-Shift Max After Midnight</th>
        </tr>
        <tr>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
          <th class="valA">A</th><th class="valB">B</th><th class="valC">C</th>
        </tr>
      </thead><tbody></tbody></table></div>
      <svg class="grip" viewBox="0 0 24 24"><path d="M8 11h8v2H8zM8 15h8v2H8zM8 7h8v2H8z"/></svg>
    </div>
    <div class="footer">Updated <span id="updated">—</span></div>
  </div>
</div>
<script>
  const el = {
    today: document.getElementById('board-today'),
    prior: document.getElementById('board-prior'),
    week: document.getElementById('board-week'),
    month: document.getElementById('board-month'),
    hdrToday: document.getElementById('hdr-today'),
    hdrPrior: document.getElementById('hdr-prior'),
    hdrWeek: document.getElementById('hdr-week'),
    hdrMonth: document.getElementById('hdr-month'),
    ts: document.getElementById('ts'),
    upd: document.getElementById('updated'),
    status: document.getElementById('status'),
    auto: document.getElementById('auto'),
    edit: document.getElementById('edit'),
    resetLayout: document.getElementById('resetLayout'),
    refresh: document.getElementById('refresh'),
    winners: document.getElementById('winners')\n  };

  function renderTable(table, data){
    var tbody = table.querySelector('tbody');
    tbody.innerHTML='';
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      var tr=document.createElement('tr');
      var td=document.createElement('td');
      td.colSpan=(table.querySelectorAll('thead th').length||4);
      td.textContent='No runs recorded.'; td.style.color='#9ca3af';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    var rows=data.rows;
    var maxC=Math.max.apply(null, rows.map(function(r){return r.calls||0;}));
    var minC=Math.min.apply(null, rows.map(function(r){return r.calls||0;}));
    function callsHeat(c){
      var n=(maxC===minC)?0.7:((c-minC)/(maxC-minC));
      var hue=200-Math.round(n*160);
      var alpha=0.22+0.28*n;
      return 'background: hsla('+hue+',85%,52%,'+alpha+'); color:#0b0d10; font-weight:700; border-radius:6px; padding:2px 8px; display:inline-block;';
    }
    rows.forEach(function(r, idx){
      var tr=document.createElement('tr');
      if(idx===0) tr.classList.add('rank-1'); if(idx===1) tr.classList.add('rank-2'); if(idx===2) tr.classList.add('rank-3');
      var tdU=document.createElement('td'); tdU.textContent=r.unit; tdU.className='col-unit'; tr.appendChild(tdU);
      var tdC=document.createElement('td'); tdC.className='col-calls'; tdC.innerHTML='<span class="pill-badge calls-badge" style="'+callsHeat(r.calls||0)+'">'+(r.calls||0)+'</span>'; tr.appendChild(tdC);
      var tdA=document.createElement('td'); tdA.className='col-avg'; tdA.innerHTML='<span class="pill-badge avg-badge">'+((r.avg_min||0).toFixed(1))+'</span>'; tr.appendChild(tdA);
      var thCount=table.querySelectorAll('thead th').length;
      if(thCount>=5){
        var tdX=document.createElement('td'); tdX.className='col-max';
        var show=(r.max_min&&r.max_min>0)? r.max_min.toFixed(1):'--';
        tdX.innerHTML='<span class="pill-badge avg-badge">'+show+'</span>';
        tr.appendChild(tdX);
      }
      var tdM=document.createElement('td'); tdM.className='col-after';
      var after=r.after_0000||0;
      if(after>0){ tdM.innerHTML='<span class="pill-badge after-badge">'+after+'</span>'; }
      else { tdM.textContent='0'; tdM.style.color='#9ca3af'; }
      tr.appendChild(tdM);
      tbody.appendChild(tr);
    });
  }

  function renderWeekMonth(table, data){
    var tbody=table.querySelector('tbody');
    tbody.innerHTML='';
    var thCount=19;
    if(!data || !Array.isArray(data.rows) || data.rows.length===0){
      var tr=document.createElement('tr'); var td=document.createElement('td'); td.colSpan=thCount; td.textContent='No runs recorded.'; td.style.color='#9ca3af'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    function fnum(v,isFloat){ return isFloat ? ((isFinite(v)? Number(v).toFixed(1):'0.0')) : (v||0); }
    function winnerIndex(arr, lowest){
      var bestIdx=-1, bestVal=null;
      for(var i=0;i<3;i++){
        var v=Number((arr && arr[i]!=null) ? arr[i] : 0);
        if(lowest){
          if(!(v>0)) continue;
          if(bestIdx===-1 || v<bestVal){ bestVal=v; bestIdx=i; }
        } else {
          if(bestIdx===-1 || v>bestVal){ bestVal=v; bestIdx=i; }
        }
      }
      return bestIdx;
    }
    data.rows.forEach(function(r,idx){
      var tr=document.createElement('tr'); if(idx===0) tr.classList.add('rank-1'); if(idx===1) tr.classList.add('rank-2'); if(idx===2) tr.classList.add('rank-3');
      var tdU=document.createElement('td'); tdU.textContent=r.unit; tr.appendChild(tdU);
      (function(){
        var classes=['valA','valB','valC'];
        function renderGroup(arr, isFloat, lowestWins){
          var wi = winnerIndex(arr, lowestWins);
          for(var i=0;i<3;i++){
            var td=document.createElement('td'); td.className=classes[i];
            var t = fnum(((arr||[])[i]||0), isFloat);
            if(wi===i){ td.innerHTML = '<span class="win"></span>'+t; } else { td.textContent = t; }
            tr.appendChild(td);
          }
        }
        renderGroup(r.calls_abc, false, false);
        renderGroup(r.calls_max_abc, false, false);
        renderGroup(r.avg_min_abc, true, true);
        renderGroup(r.max_min_abc, true, true);
        renderGroup(r.after_abc, false, false);
        renderGroup(r.after_max_abc, false, false);
      })();
      tbody.appendChild(tr);
    });
  }

  function setPanelShift(panelId, letter){ var p=document.getElementById(panelId); if(!p||!letter) return; p.classList.remove('shift-a','shift-b','shift-c'); var l=(letter+'').toUpperCase(); if(l==='A') p.classList.add('shift-a'); if(l==='B') p.classList.add('shift-b'); if(l==='C') p.classList.add('shift-c'); }
  function letterFromMeta(meta){ if(!meta||!meta.shift_date) return ''; var m=/^([ABC])\-Shift\s/.exec(meta.shift_date.trim()); return m? m[1]:''; }

  function apply(data){
    var errors=[]; function safe(label,fn){ try{ fn(); } catch(e){ console.error('render error',label,e); errors.push(label); } }
    if(data.today){ safe('Today', function(){ renderTable(el.today, data.today); el.hdrToday.textContent=(data.today.meta&&data.today.meta.shift_date)||new Date(data.today.updated||Date.now()).toLocaleTimeString(); setPanelShift('panel-today', letterFromMeta(data.today.meta)); }); }
    if(data.prior){ safe('Prior', function(){ renderTable(el.prior, data.prior); el.hdrPrior.textContent=(data.prior.meta&&data.prior.meta.shift_date)||new Date(data.prior.updated||Date.now()).toLocaleTimeString(); setPanelShift('panel-prior', letterFromMeta(data.prior.meta)); }); }
    if(data.week){ safe('Week', function(){ renderWeekMonth(el.week, data.week); el.hdrWeek.textContent=(data.week.meta&&data.week.meta.range)||new Date(data.week.updated||Date.now()).toLocaleTimeString(); }); }
    if(data.month){ safe('Month', function(){ renderWeekMonth(el.month, data.month); el.hdrMonth.textContent=(data.month.meta&&data.month.meta.range)||new Date(data.month.updated||Date.now()).toLocaleTimeString(); }); }
    el.ts.textContent='Fetched '+new Date().toLocaleTimeString(); el.upd.textContent=new Date().toLocaleString();
    if(errors.length){ el.status.style.display='inline-block'; el.status.textContent='Render error: '+errors.join(', '); el.status.title='One or more panels failed to render'; } else { el.status.style.display='none'; el.status.textContent=''; el.status.title=''; }
  }

  async function fetchOnce(){
    try{
      var r=await fetch('data.json?t='+Date.now(), {cache:'no-cache'});
      if(!r.ok){ el.status.style.display='inline-block'; el.status.textContent='Fetch error: '+r.status+' '+r.statusText; return; }
      var j=await r.json(); if(!j || (!j.today && !j.week && !j.prior && !j.month)){ el.status.style.display='inline-block'; el.status.textContent='No data in payload'; return; }
      apply(j);
    }catch(e){ console.error('fetch error', e); el.status.style.display='inline-block'; el.status.textContent='Fetch error (network/parse)'; }
  }

  var interval=null; function startAuto(){ stopAuto(); interval=setInterval(fetchOnce, 60000); } function stopAuto(){ if(interval) clearInterval(interval); interval=null; }
  el.auto.onchange=function(){ if(el.auto.checked) startAuto(); else stopAuto(); };
  el.refresh.onclick=function(){ fetchOnce(); };
el.winners.onchange=function(){ document.body.classList.toggle('winners-on', el.winners.checked); };

  var panels={ today:document.getElementById('panel-today'), prior:document.getElementById('panel-prior'), week:document.getElementById('panel-week'), month:document.getElementById('panel-month') };
  var defaultLayout={ today:{left:2,top:8,width:46,height:60}, prior:{left:2,top:70,width:46,height:28}, week:{left:50,top:8,width:48,height:40}, month:{left:50,top:50,width:48,height:48} };
  function loadLayout(){ try{ var j=JSON.parse(localStorage.getItem('ppfd_layout_v1')||'{}'); var out={}; for(var k in defaultLayout){ out[k]=defaultLayout[k]; } for(var k2 in j){ out[k2]=j[k2]; } return out; }catch(e){ var d={}; for(var k3 in defaultLayout){ d[k3]=defaultLayout[k3]; } return d; } }
  function saveLayout(l){ try{ localStorage.setItem('ppfd_layout_v1', JSON.stringify(l)); }catch(e){} }
  function isDefaultLayout(l){ var tol=0.001; for(var k in defaultLayout){ var a=l[k]||defaultLayout[k], b=defaultLayout[k]; var keys=['left','top','width','height']; for(var i=0;i<keys.length;i++){ var key=keys[i]; if(Math.abs(((a[key]||0)-(b[key]||0)))>tol) return false; } } return true; }
  function applyLayout(l){ for(var k in panels){ var p=panels[k]; var r=l[k]||defaultLayout[k]; p.style.left=r.left+'vw'; p.style.top=r.top+'vh'; p.style.width=r.width+'vw'; p.style.height=r.height+'vh'; } }
  function enableEditing(on){ document.body.classList.toggle('edit-on', !!on); }
  var layoutState={ current: loadLayout() };
  applyLayout(layoutState.current); enableEditing(false); document.body.classList.toggle('winners-on', el.winners && el.winners.checked);
  function updateFlowMode(){ var isMobile=window.matchMedia('(max-width: 900px)').matches; var canvas=document.querySelector('.canvas'); if(!canvas) return; if(!el.edit.checked && isDefaultLayout(layoutState.current) && !isMobile){ canvas.classList.add('flow'); for(var k in panels){ var p=panels[k]; p.style.left=''; p.style.top=''; p.style.width=''; p.style.height=''; } } else { canvas.classList.remove('flow'); applyLayout(layoutState.current); } }
  updateFlowMode();
  function attachDragResize(key){ var node=panels[key]; var handle=node.querySelector('.hdr'); var grip=node.querySelector('.grip'); var state={drag:false,size:false,sx:0,sy:0,start:null}; function downDrag(e){ if(!el.edit.checked) return; state.drag=true; state.sx=e.clientX; state.sy=e.clientY; var r=layoutState.current[key]||defaultLayout[key]; state.start={left:r.left,top:r.top,width:r.width,height:r.height}; e.preventDefault(); } function downSize(e){ if(!el.edit.checked) return; state.size=true; state.sx=e.clientX; state.sy=e.clientY; var r=layoutState.current[key]||defaultLayout[key]; state.start={left:r.left,top:r.top,width:r.width,height:r.height}; e.preventDefault(); } function move(e){ if(!(state.drag||state.size)) return; var vw=innerWidth, vh=innerHeight; var dx=(e.clientX-state.sx)/vw*100; var dy=(e.clientY-state.sy)/vh*100; var r=layoutState.current[key]||(layoutState.current[key]={left:defaultLayout[key].left,top:defaultLayout[key].top,width:defaultLayout[key].width,height:defaultLayout[key].height}); if(state.drag){ r.left=Math.max(0, Math.min(100-r.width, state.start.left+dx)); r.top=Math.max(0, Math.min(100-r.height, state.start.top+dy)); } if(state.size){ r.width=Math.min(100-r.left, Math.max(20, state.start.width+dx)); r.height=Math.min(100-r.top, Math.max(20, state.start.height+dy)); } applyLayout(layoutState.current); } function up(){ if(!(state.drag||state.size)) return; state.drag=false; state.size=false; saveLayout(layoutState.current); } handle.addEventListener('mousedown', downDrag); grip.addEventListener('mousedown', downSize); window.addEventListener('mousemove', move); window.addEventListener('mouseup', up); handle.addEventListener('touchstart', function(ev){downDrag(ev.touches[0])}); grip.addEventListener('touchstart', function(ev){downSize(ev.touches[0])}); window.addEventListener('touchmove', function(ev){move(ev.touches[0])}); window.addEventListener('touchend', up); }
  attachDragResize('today'); attachDragResize('prior'); attachDragResize('week'); attachDragResize('month');
  el.edit.onchange=function(){ enableEditing(el.edit.checked); updateFlowMode(); };
  el.resetLayout.onclick=function(){ layoutState.current={today:{left:2,top:8,width:46,height:60}, prior:{left:2,top:70,width:46,height:28}, week:{left:50,top:8,width:48,height:40}, month:{left:50,top:50,width:48,height:48}}; saveLayout(layoutState.current); applyLayout(layoutState.current); updateFlowMode(); };
  window.addEventListener('resize', updateFlowMode);
  fetchOnce(); startAuto();
</script>
